<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–≤–µ—Ç–∞</title>
  
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- HTML2Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Tone.js (–ó–≤—É–∫–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    /* --- OVERRIDES FOR DARK THEME --- */
    :root {
      --bg: #0f1724;
      --card-bg: #1e293b;
      --text-main: #e6eef6;
      --text-muted: #94a3b8;
      --accent: #6ee7b7; /* Teal-ish green */
      --accent-dark: #059669;
      --danger: #fb7185;
      --border: rgba(255,255,255,0.1);
    }

    body {
      background-color: var(--bg);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
    }

    /* Navbar / Header styling */
    nav {
      background-color: transparent;
      box-shadow: none;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    nav .brand-logo {
      font-size: 1.5rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Cards */
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .card-content {
      padding: 20px;
    }

    /* Inputs & Textareas (Dark Mode overrides) */
    .input-field input[type=text], 
    .input-field textarea.materialize-textarea {
      color: var(--text-main);
      border-bottom: 1px solid var(--border);
    }
    .input-field input[type=text]:focus, 
    .input-field textarea.materialize-textarea:focus {
      border-bottom: 1px solid var(--accent);
      box-shadow: 0 1px 0 0 var(--accent);
    }
    .input-field label {
      color: var(--text-muted);
    }
    .input-field input[type=text]:focus + label, 
    .input-field textarea.materialize-textarea:focus + label {
      color: var(--accent);
    }

    /* Checkboxes */
    [type="checkbox"] + span:not(.lever) {
      color: var(--text-main);
    }
    [type="checkbox"]:checked + span:not(.lever):before {
      border-right: 2px solid var(--accent);
      border-bottom: 2px solid var(--accent);
    }

    /* Tabs */
    .tabs {
      background-color: transparent;
      border-bottom: 1px solid var(--border);
    }
    .tabs .tab a {
      color: var(--text-muted);
      font-weight: 600;
    }
    .tabs .tab a:hover, .tabs .tab a.active {
      color: var(--accent);
      background-color: rgba(110, 231, 183, 0.05);
    }
    .tabs .indicator {
      background-color: var(--accent);
    }

    /* Buttons */
    .btn, .btn-large {
      background-color: var(--accent);
      color: #0f1724;
      font-weight: 700;
    }
    .btn:hover, .btn-large:hover {
      background-color: #34d399;
    }
    .btn-flat {
      color: var(--text-main);
    }
    .btn:disabled {
      background-color: #334155 !important;
      color: #64748b !important;
    }

    /* Chips (Tags) */
    .chip {
      background-color: rgba(255,255,255,0.1);
      color: var(--text-main);
    }
    .chip.added {
      background-color: rgba(110, 231, 183, 0.15);
      color: var(--accent);
    }
    .chip.removed {
      background-color: rgba(251, 113, 133, 0.15);
      color: var(--danger);
    }

    /* Result Row (Comparator) */
    .diff-row {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px 15px;
    }
    .diff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
    }
    summary {
      color: var(--text-muted);
      cursor: pointer;
      outline: none;
    }

    /* --- MODAL STYLING (VISUALIZER) --- */
    .modal {
      background-color: var(--card-bg);
      color: var(--text-main);
      max-height: 90%;
      width: 95%; /* Wider modal for chart */
      max-width: 1400px;
      border-radius: 12px;
    }
    .modal .modal-footer {
      background-color: #162032;
      border-top: 1px solid var(--border);
    }
    /* Fix scrollbar in modal */
    .modal-content {
      padding: 24px;
    }

    /* --- CHART GRID STYLES --- */
    .chart-scroll-wrapper {
      overflow-x: auto;
      padding-bottom: 10px;
      /* Custom Scrollbar */
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--bg);
    }
    .chart-scroll-wrapper::-webkit-scrollbar {
      height: 8px;
    }
    .chart-scroll-wrapper::-webkit-scrollbar-track {
      background: var(--bg);
    }
    .chart-scroll-wrapper::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 4px;
    }

    #chart-grid {
      display: grid;
      /* 1st col (label): 180px, then 48 slots */
      grid-template-columns: 180px repeat(48, minmax(20px, 1fr));
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 1200px; /* Force scroll on mobile */
    }

    .grid-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      font-size: 12px;
      height: 45px;
      color: var(--text-muted);
      position: relative;
    }

    /* Header Cells (Time) */
    .header-cell {
      background-color: rgba(110,231,183,0.05);
      color: var(--accent);
      font-weight: bold;
      grid-column: span 2; /* 1 hour = 2 slots */
    }

    /* Corner Cell (Date) */
    .corner-cell {
      color: var(--accent);
      font-family: 'Inter', sans-serif;
      border-right: none;
      padding: 0 10px;
      justify-content: center; 
      background-color: rgba(110,231,183,0.05);
    }
    .date-display {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(110, 231, 183, 0.3);
    }

    /* Label Cells (Groups) */
    .label-cell {
      background-color: rgba(110,231,183,0.05);
      color: var(--text-main);
      font-weight: 600;
      justify-content: space-between; /* Space between name and time */
      padding: 0 12px;
      text-align: left;
      border-right: 2px solid var(--accent); /* Separator */
      white-space: nowrap;
    }
    .label-cell span.total-time {
      font-size: 0.85em;
      color: var(--accent);
      opacity: 0.9;
      margin-left: 8px;
    }

    /* Data Cells */
    .data-cell.off {
      background-color: rgba(251, 113, 133, 0.15);
      color: var(--danger);
    }
    /* Remove last borders */
    .grid-cell:nth-child(49n+1) { border-right: none; } /* Logic adjusted for grid structure */
    
    /* FOOTER TOTAL ROW */
    .grid-footer {
      grid-column: 1 / -1; /* Span ALL columns */
      background-color: rgba(255,255,255,0.03);
      color: var(--text-main);
      padding: 12px 20px;
      font-weight: 600;
      border-top: 2px solid var(--border);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }
    .grid-footer strong {
      color: var(--accent);
      font-size: 1.1em;
    }

    /* Move Button Styling */
    .move-btn-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 0;
    }
    .btn-move {
      border: 1px solid var(--border);
      background: transparent;
      box-shadow: none;
      color: var(--accent);
    }
    .btn-move:hover {
      background: rgba(110, 231, 183, 0.1);
      box-shadow: 0 0 10px rgba(110, 231, 183, 0.2);
    }

    /* Utilities */
    .hidden { display: none !important; }
    .mt-2 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 1rem; }
    
    .helper-text { color: var(--text-muted); font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px; display: block;}
    
    /* Auto-update status */
    #update-status {
        text-align: right;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: -15px;
        margin-bottom: 15px;
        padding-right: 15px;
    }

  </style>
</head>
<body>

  <div class="container">
    
    <!-- HEADER -->
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo">
          <i class="material-icons" style="color: var(--accent)">bolt</i>
          <span style="font-size: 1.2rem; font-weight: 600;">–ì—Ä–∞—Ñ–∏–∫–∏ –°–≤–µ—Ç–∞</span>
        </a>
      </div>
    </nav>
    <div id="update-status">–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>

    <!-- TABS -->
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s6"><a class="active" href="#comparator">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a></li>
          <li class="tab col s6"><a href="#visualizer">–í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä</a></li>
        </ul>
      </div>
    </div>

    <!-- VIEW 1: COMPARATOR -->
    <div id="comparator" class="col s12">
      <div class="card">
        <div class="card-content">
          <div class="row" style="display: flex; flex-wrap: wrap; align-items: center;">
            <!-- Old Input -->
            <div class="input-field col s12 m5">
              <textarea id="old" class="materialize-textarea" placeholder="1.1: 00:00-04:00"></textarea>
              <label for="old">–°—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π)</label>
            </div>

            <!-- Move Button (Interactive compare_arrows) -->
            <div class="col s12 m2 move-btn-container">
              <button id="moveDataBtn" class="btn-floating btn-large btn-move waves-effect" title="–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ù–æ–≤—ã–π –≤ –°—Ç–∞—Ä—ã–π">
                <i class="material-icons">compare_arrows</i>
              </button>
            </div>

            <!-- New Input -->
            <div class="input-field col s12 m5">
              <textarea id="new" class="materialize-textarea" placeholder="1.1: 00:00-03:00&#10;–ò–ª–∏ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:&#10;–ß–µ—Ä–≥–∞ 1.1: –∑ 00:00 –¥–æ 03:00"></textarea>
              <label for="new">–ù–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)</label>
            </div>
          </div>

          <div class="row">
            <div class="col s12 m6">
               <label>
                <input type="checkbox" id="onlyChanges" />
                <span style="color: var(--text-main)">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
              </label>
            </div>
            <!-- SOUND TOGGLE -->
            <div class="col s12 m6 right-align">
               <label>
                <input type="checkbox" id="soundEnabled" checked />
                <span style="color: var(--accent); font-weight: bold;">üîä –ó–≤—É–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</span>
              </label>
            </div>
          </div>

          <div class="row" style="margin-top: 20px;">
            <div class="col s12">
              <button id="compareBtn" class="btn waves-effect waves-light">–°—Ä–∞–≤–Ω–∏—Ç—å –∏ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
              <button id="clearBtn" class="btn-flat waves-effect">–û—á–∏—Å—Ç–∏—Ç—å</button>
              
              <div class="right hide-on-small-only">
                 <!-- Hidden file input -->
                 <input type="file" id="jsonInput" accept=".json" style="display:none">
                 <button id="importJsonBtn" class="btn-small btn-flat waves-effect"><i class="material-icons left">file_upload</i>–ò–º–ø–æ—Ä—Ç JSON</button>
                 <button id="copyJsonBtn" class="btn-small btn-flat waves-effect"><i class="material-icons left">content_copy</i>JSON</button>
              </div>
            </div>
          </div>

          <!-- Results Area -->
          <div id="resultArea" class="mt-2">
            <!-- Dynamic content here -->
            <div class="center-align" style="padding: 30px; opacity: 0.5">
              <i class="material-icons" style="font-size: 3rem;">analytics</i>
              <p>–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ä–∞–≤–Ω–∏—Ç—å"</p>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- VIEW 2: VISUALIZER -->
    <div id="visualizer" class="col s12">
      <div class="card">
        <div class="card-content">
          <span class="card-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≥—Ä–∞—Ñ–∏–∫–∞</span>
          <span class="helper-text">–í—Å—Ç–∞–≤—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞ –Ω–∞ —Å—Ç—Ä–æ–∫—É). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã —Å —Ç–∏—Ä–µ, –∑–∞–ø—è—Ç—ã–º–∏, —Å–ª–æ–≤–∞–º–∏ "–∑", "–¥–æ".</span>

          <div class="input-field">
            <textarea id="vizInput" class="materialize-textarea" style="min-height: 150px;" placeholder="–ß–µ—Ä–≥–∞ 1.1: –∑ 00:00 –¥–æ 02:00, –∑ 15:00 –¥–æ 20:00&#10;1.2: 02:00 ‚Äì 06:00"></textarea>
            <label for="vizInput">–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞</label>
          </div>

          <div class="row" style="margin-bottom: 0;">
             <div class="col s12 mb-2">
               <label>
                <input type="checkbox" id="nextDayCheck" />
                <span>–ì—Ä–∞—Ñ–∏–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (—Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)</span>
              </label>
             </div>
          </div>

          <div class="row">
            <div class="col s12">
              <button id="generateVizBtn" class="btn btn-large waves-effect waves-light" style="width: 100%">
                <i class="material-icons left">bar_chart</i>
                –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div> <!-- .container -->

  <!-- MODAL: CHART RESULT -->
  <div id="chartModal" class="modal bottom-sheet-on-mobile">
    <div class="modal-content">
      <h5 class="mb-2">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏–π</h5>
      
      <!-- Wrapper for horizontal scrolling -->
      <div class="chart-scroll-wrapper" id="chartWrapper">
        <div id="chart-grid">
          <!-- Grid will be injected here -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="left hide-on-small-only" style="padding: 10px; color: var(--text-muted); font-size: 0.8rem;">
        * –í—Ä–µ–º—è —É–∫–∞–∑–∞–Ω–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∫–æ–ª–æ–Ω–æ–∫
      </span>
      <a href="#!" class="modal-close btn-flat waves-effect">–ó–∞–∫—Ä—ã—Ç—å</a>
      <button id="downloadPngBtn" class="btn waves-effect waves-light">
        <i class="material-icons left">download</i>–°–∫–∞—á–∞—Ç—å
      </button>
    </div>
  </div>

  <!-- JS: Materialize + App Logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Init Materialize Components
      M.AutoInit();
      
      // --- –≠–õ–ï–ú–ï–ù–¢–´ ---
      const compareBtn = document.getElementById('compareBtn');
      const moveDataBtn = document.getElementById('moveDataBtn');
      const clearBtn = document.getElementById('clearBtn');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      const importJsonBtn = document.getElementById('importJsonBtn');
      const jsonInput = document.getElementById('jsonInput');

      const oldInput = document.getElementById('old');
      const newInput = document.getElementById('new');
      const resultArea = document.getElementById('resultArea');
      const onlyChangesCheck = document.getElementById('onlyChanges');
      const updateStatus = document.getElementById('update-status');
      
      const soundEnabledCheck = document.getElementById('soundEnabled');

      const generateVizBtn = document.getElementById('generateVizBtn');
      const vizInput = document.getElementById('vizInput');
      const nextDayCheck = document.getElementById('nextDayCheck');
      const chartModalEl = document.getElementById('chartModal');
      const chartGrid = document.getElementById('chart-grid');
      const downloadPngBtn = document.getElementById('downloadPngBtn');

      const chartModalInstance = M.Modal.getInstance(chartModalEl);

      // --- SOUND SYSTEM (Tone.js) ---
      let synth = null;
      let audioEnabled = false;

      // Tone.js —Ç—Ä–µ–±—É–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ AudioContext
      async function initAudio() {
        if (!audioEnabled) {
          try {
            await Tone.start();
            // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–ª–∏—Ñ–æ–Ω–∏—á–µ—Å–∫–∏–π —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            synth.volume.value = -8; // –ù–µ–º–Ω–æ–≥–æ —Ç–∏—à–µ
            audioEnabled = true;
            console.log("Audio initialized");
          } catch(e) {
            console.error("Audio init failed", e);
          }
        }
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
      document.body.addEventListener('click', initAudio, { once: true });

      function playNotificationSound() {
        if (!soundEnabledCheck.checked || !audioEnabled || !synth) return;
        
        const now = Tone.now();
        // –ò–≥—Ä–∞–µ–º –º–∞–∂–æ—Ä–Ω–æ–µ –∞—Ä–ø–µ–¥–∂–∏–æ (–ø—Ä–∏—è—Ç–Ω—ã–π –¥–∑—ã–Ω—å)
        synth.triggerAttackRelease("C5", "16n", now);
        synth.triggerAttackRelease("E5", "16n", now + 0.1);
        synth.triggerAttackRelease("G5", "16n", now + 0.2);
        synth.triggerAttackRelease("C6", "8n", now + 0.3);
      }

      // –ú–∏–≥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤–∫–ª–∞–¥–∫–∏
      let titleInterval = null;
      function startFlashingTitle() {
        if (titleInterval) return;
        const originalTitle = document.title;
        let isAlert = false;
        titleInterval = setInterval(() => {
          document.title = isAlert ? "üîî –û–ë–ù–û–í–õ–ï–ù–ò–ï!" : originalTitle;
          isAlert = !isAlert;
        }, 1000);

        // –°–±—Ä–æ—Å –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –æ–∫–Ω–æ
        window.addEventListener('focus', () => {
          clearInterval(titleInterval);
          titleInterval = null;
          document.title = originalTitle;
        }, { once: true });
      }


      // --- –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ---
      function loadFromStorage() {
        if (localStorage.getItem('svet_old')) oldInput.value = localStorage.getItem('svet_old');
        if (localStorage.getItem('svet_new')) newInput.value = localStorage.getItem('svet_new');
        if (localStorage.getItem('svet_viz')) vizInput.value = localStorage.getItem('svet_viz');
        
        // –ó–≤—É–∫
        const savedSound = localStorage.getItem('svet_sound_enabled');
        if(savedSound !== null) soundEnabledCheck.checked = (savedSound === 'true');

        M.updateTextFields();
        M.textareaAutoResize(oldInput);
        M.textareaAutoResize(newInput);
        M.textareaAutoResize(vizInput);
      }

      oldInput.addEventListener('input', () => localStorage.setItem('svet_old', oldInput.value));
      newInput.addEventListener('input', () => localStorage.setItem('svet_new', newInput.value));
      vizInput.addEventListener('input', () => localStorage.setItem('svet_viz', vizInput.value));
      
      soundEnabledCheck.addEventListener('change', () => {
         localStorage.setItem('svet_sound_enabled', soundEnabledCheck.checked);
         // –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ –≥–∞–ª–æ—á–∫—É, —Å—Ä–∞–∑—É –ø–æ–ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ (–≤–¥—Ä—É–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –∫–ª–∏–∫–Ω—É–ª)
         if(soundEnabledCheck.checked) initAudio(); 
      });
      
      loadFromStorage();
      
      // --- HELPER: PARSE DATE ---
      function parseDateStr(str) {
         if(!str) return 0;
         const parts = str.split('.');
         if(parts.length < 3) return 0;
         return new Date(parts[2], parts[1]-1, parts[0]).getTime();
      }

      // --- HELPER: FORMAT SINGLE DAY ---
      function formatSingleDay(day) {
         if (!day || !day.queues) return '';
         let resultText = `=== ${day.date} ===\n`;
         // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª—é—á–∞–º 1.1, 1.2
         Object.keys(day.queues).sort().forEach(q => {
              resultText += `${q}: ${day.queues[q]}\n`;
         });
         return resultText.trim();
      }

      // --- PROCESS DATA ---
      // isAutoUpdate = true, –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ —Ç–∞–π–º–µ—Ä–æ–º (–¥–ª—è –∑–≤—É–∫–∞)
      function processJsonData(dataArray, isAutoUpdate = false) {
          if (!dataArray || !Array.isArray(dataArray) || dataArray.length === 0) return false;

          const sortedDays = [...dataArray].sort((a, b) => {
              return parseDateStr(b.date) - parseDateStr(a.date);
          });

          const latestDay = sortedDays[0];
          const latestText = formatSingleDay(latestDay);

          let previousText = '';
          if (sortedDays.length > 1) {
              previousText = formatSingleDay(sortedDays[1]);
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          const currentSavedNew = localStorage.getItem('svet_new') || '';
          
          let dataChanged = false;

          if (latestText && latestText !== currentSavedNew) {
              // –ï–°–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø!
              dataChanged = true;

              // –°–¥–≤–∏–≥–∞–µ–º —Å—Ç–∞—Ä–æ–µ
              if (previousText) {
                   localStorage.setItem('svet_old', previousText);
                   oldInput.value = previousText;
              } else if (currentSavedNew) {
                   // –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ "–ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ" –≤ json, –±–µ—Ä–µ–º —Ç–æ —á—Ç–æ –±—ã–ª–æ –≤ –ø–æ–ª–µ New
                   localStorage.setItem('svet_old', currentSavedNew);
                   oldInput.value = currentSavedNew;
              }

              // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ
              localStorage.setItem('svet_new', latestText);
              newInput.value = latestText;
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
              localStorage.setItem('svet_viz', latestText);
              vizInput.value = latestText;
          } else {
              // –î–∞–Ω–Ω—ã–µ —Ç–µ –∂–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
              if (!newInput.value && latestText) newInput.value = latestText;
              if (!vizInput.value && latestText) vizInput.value = latestText;
          }

          M.updateTextFields();
          M.textareaAutoResize(oldInput);
          M.textareaAutoResize(newInput);
          M.textareaAutoResize(vizInput);

          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
          if (isAutoUpdate && dataChanged) {
              playNotificationSound();
              startFlashingTitle();
              M.toast({html: '–ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫!', classes: 'green rounded', displayLength: 6000});
          }

          return true;
      }

      // --- AUTO UPDATE ---
      const JSON_URL = 'schedule.json'; 

      async function checkForUpdates() {
          if (window.location.protocol === 'file:') {
               updateStatus.innerHTML = '<span style="color:var(--text-muted)">–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)</span>';
               return;
          }

          try {
              const res = await fetch(JSON_URL + '?t=' + Date.now()); 
              if (!res.ok) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
              const jsonData = await res.json();
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º "—Å—ã—Ä—É—é" –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å –ª–æ–≥–∏–∫—É –∑—Ä—è
              const rawStr = JSON.stringify(jsonData);
              const lastRaw = localStorage.getItem('svet_last_raw_json');
              
              if (rawStr !== lastRaw) {
                  // –î–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                  const success = processJsonData(jsonData, true); // true = –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                  if (success) {
                      localStorage.setItem('svet_last_raw_json', rawStr);
                      updateStatus.innerHTML = '<span style="color:var(--accent)">‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ</span>';
                  }
              } else {
                  updateStatus.innerHTML = '<span style="color:var(--text-muted)">–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã</span>';
                  // –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã
                  if(!newInput.value) processJsonData(jsonData, false);
              }

          } catch (e) {
              console.log("Auto-update info: " + e.message);
              updateStatus.innerHTML = '<span style="color:var(--text-muted)">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</span>';
          }
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      checkForUpdates();
      // –ò –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
      setInterval(checkForUpdates, 60000);

      // --- MANUAL JSON IMPORT ---
      importJsonBtn.addEventListener('click', () => {
          jsonInput.click();
      });

      jsonInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(evt) {
              try {
                  const jsonData = JSON.parse(evt.target.result);
                  // –ü—Ä–∏ —Ä—É—á–Ω–æ–º –∏–º–ø–æ—Ä—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ (false)
                  const success = processJsonData(jsonData, false); 
                  
                  if (success) {
                      M.toast({html: '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', classes: 'green'});
                  } else {
                      M.toast({html: '–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç', classes: 'red'});
                  }
              } catch (err) {
                  console.error(err);
                  M.toast({html: '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON', classes: 'red'});
              }
              jsonInput.value = '';
          };
          reader.readAsText(file);
      });


      // --- –ü–ê–†–°–ò–ù–ì ---
      const pad = (t) => {
        const [h,m] = t.split(':');
        return h.padStart(2,'0') + ':' + m;
      };

      function parseScheduleLine(line) {
        line = line.trim();
        if (!line) return null;
        if (line.startsWith('===')) return null; 

        // –ò—â–µ–º 1.1: –∏–ª–∏ –ß–µ—Ä–≥–∞ 1.1:
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ—á–∫–∏ –∏ –¥–≤–æ–µ—Ç–æ—á–∏—è –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
        const match = line.match(/^(?:–ß–µ—Ä–≥–∞|–ì—Ä—É–ø–∞|–ß–µ—Ä–≥–∏)?\s*(\d(?:\.\d)?)\s*[:\.]\s*(.+)/i);
        if (!match) return null;

        const name = match[1];
        const timePart = match[2];
        
        const ranges = [];
        const globalIntervalPattern = /(\d{1,2}:\d{2})\s*(?:[-‚Äì‚Äî]|–¥–æ)\s*(\d{1,2}:\d{2})/gi;
        
        let m;
        while ((m = globalIntervalPattern.exec(timePart)) !== null) {
            ranges.push({
                startStr: pad(m[1]),
                endStr: pad(m[2]),
                raw: m[0]
            });
        }

        return { name, ranges };
      }

      function normalizeIntervals(arr){
        const mapped = arr.map(a => ({s: a[0], e: a[1], str: a[0]+"-"+a[1]}));
        mapped.sort((x,y) => timeToMin(x.s) - timeToMin(y.s));
        const uniq = [];
        for(const it of mapped){
          if(!uniq.length || uniq[uniq.length-1].str !== it.str) uniq.push(it);
        }
        return uniq.map(x => x.str);
      }

      function timeToMin(t){
        const [h,m] = t.split(':').map(Number);
        return h*60 + m;
      }

      function parseTimeMinutes(str) {
        if(str === '24:00') return 1440;
        const [h, m] = str.split(':').map(Number);
        return h*60 + m;
      }

      function compareSets(oldArr, newArr){
        const oldSet = new Set(oldArr);
        const newSet = new Set(newArr);
        const removed = [...oldSet].filter(x => !newSet.has(x));
        const added = [...newSet].filter(x => !oldSet.has(x));
        removed.sort((a,b) => timeToMin(a.split('-')[0]) - timeToMin(b.split('-')[0]));
        added.sort((a,b) => timeToMin(a.split('-')[0]) - timeToMin(b.split('-')[0]));
        return {removed, added};
      }

      function escapeHtml(s){ 
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); 
      }

      // --- –õ–û–ì–ò–ö–ê –ö–û–ú–ü–ê–†–ê–¢–û–†–ê ---
      
      moveDataBtn.addEventListener('click', () => {
        if (!newInput.value.trim()) {
           M.toast({html: '–ü–æ–ª–µ "–ù–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫" –ø—É—Å—Ç–æ–µ', classes: 'rounded'});
           return;
        }
        oldInput.value = newInput.value;
        newInput.value = '';
        localStorage.setItem('svet_old', oldInput.value);
        localStorage.setItem('svet_new', '');
        M.updateTextFields();
        M.textareaAutoResize(oldInput);
        M.textareaAutoResize(newInput);
        M.toast({html: '–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –°—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫'});
      });

      function parseBlock(text){
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        const data = {};
        
        for(const line of lines){
          const parsed = parseScheduleLine(line);
          if(!parsed) continue;
          const intervals = parsed.ranges.map(r => [r.startStr, r.endStr]);
          data[parsed.name] = normalizeIntervals(intervals);
        }
        return data;
      }

      compareBtn.addEventListener('click', () => {
        const dOld = parseBlock(oldInput.value);
        const dNew = parseBlock(newInput.value);
        
        if (newInput.value.trim()) {
            vizInput.value = newInput.value;
            localStorage.setItem('svet_viz', vizInput.value);
            M.textareaAutoResize(vizInput);
            M.updateTextFields();
        }

        const keys = Array.from(new Set([...Object.keys(dOld), ...Object.keys(dNew)])).sort();
        
        resultArea.innerHTML = '';
        const onlyDiff = onlyChangesCheck.checked;
        let hasContent = false;
        
        const summaryJson = {};

        keys.forEach(key => {
          const oldA = dOld[key] || [];
          const newA = dNew[key] || [];
          const diff = compareSets(oldA, newA);
          summaryJson[key] = {old: oldA, new: newA, changes: diff};

          if(onlyDiff && !diff.removed.length && !diff.added.length) return;
          hasContent = true;

          const div = document.createElement('div');
          div.className = 'diff-row';
          
          let html = `
            <div class="diff-header">
              <div>
                <span style="font-weight:bold; font-size:1.1rem">${escapeHtml(key)}</span>
                <span class="grey-text text-lighten-1" style="font-size:0.85rem; margin-left:10px">
                   ${newA.length ? newA.length + ' –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤' : '–ü—É—Å—Ç–æ'}
                </span>
              </div>
              <div style="text-align:right">
                ${diff.removed.map(r => `<span class="chip removed">-${r}</span>`).join('')}
                ${diff.added.map(a => `<span class="chip added">+${a}</span>`).join('')}
              </div>
            </div>
            <details>
              <summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
              <pre style="white-space:pre-wrap; font-family:monospace; font-size:0.9rem; margin-top:5px; color:#ccc">–°—Ç–∞—Ä–æ–µ: ${oldA.join(', ') || '‚Äî'}\n–ù–æ–≤–æ–µ:  ${newA.join(', ') || '‚Äî'}</pre>
            </details>
          `;
          div.innerHTML = html;
          resultArea.appendChild(div);
        });

        if(!hasContent) {
          resultArea.innerHTML = '<div class="center-align muted">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
        }
        resultArea.dataset.json = JSON.stringify(summaryJson, null, 2);
      });

      clearBtn.addEventListener('click', ()=>{
        oldInput.value = ''; newInput.value = ''; resultArea.innerHTML = '';
        localStorage.removeItem('svet_old');
        localStorage.removeItem('svet_new');
        M.textareaAutoResize(oldInput);
        M.textareaAutoResize(newInput);
      });

      copyJsonBtn.addEventListener('click', ()=>{
        const txt = resultArea.dataset.json || '{}';
        navigator.clipboard.writeText(txt).then(()=> M.toast({html: 'JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'}));
      });


      // --- –õ–û–ì–ò–ö–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¢–û–†–ê (MODAL) ---

      function mergeIntervals(ranges) {
        if(!ranges.length) return [];
        ranges.sort((a,b) => a.start - b.start);
        const result = [];
        let curr = {...ranges[0]};
        for(let i=1; i<ranges.length; i++){
          if(ranges[i].start <= curr.end) {
            curr.end = Math.max(curr.end, ranges[i].end);
          } else {
            result.push(curr);
            curr = {...ranges[i]};
          }
        }
        result.push(curr);
        return result;
      }

      function fmtDuration(mins) {
        const h = Math.floor(mins/60);
        const m = mins % 60;
        let s = '';
        if(h > 0) s += h + '—á ';
        if(m > 0) s += m + '–º–∏–Ω';
        return s.trim() || '0–º–∏–Ω';
      }
      
      function getChartDate() {
        const now = new Date();
        if (nextDayCheck.checked) {
          now.setDate(now.getDate() + 1);
        }
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        return `${day}.${month}`;
      }

      function generateChart() {
        const text = vizInput.value;
        const lines = text.trim().split('\n');
        const data = [];

        for(const line of lines){
          const parsed = parseScheduleLine(line);
          if(!parsed) continue;
          
          const ranges = parsed.ranges.map(r => ({
              start: parseTimeMinutes(r.startStr),
              end: parseTimeMinutes(r.endStr)
          }));
          
          const merged = mergeIntervals(ranges);
          const totalMins = merged.reduce((acc, r) => acc + (r.end - r.start), 0);
          
          data.push({
            group: parsed.name,
            ranges: merged,
            totalMinsNumeric: totalMins,
            totalStr: fmtDuration(totalMins)
          });
        }

        if(!data.length) {
          M.toast({html: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', classes: 'red'});
          return;
        }

        const dateStr = getChartDate();
        renderGrid(data, dateStr);
        chartModalInstance.open();
      }

      function renderGrid(data, dateStr) {
        chartGrid.innerHTML = '';
        
        // 1. –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const corner = document.createElement('div');
        corner.className = 'grid-cell corner-cell';
        corner.innerHTML = `<span class="date-display">${dateStr}</span>`; 
        chartGrid.appendChild(corner);

        // 2. –ß–∞—Å—ã
        for(let h=0; h<24; h++){
          const cell = document.createElement('div');
          cell.className = 'grid-cell header-cell';
          cell.textContent = h.toString().padStart(2,'0') + ':00';
          chartGrid.appendChild(cell);
        }

        // 3. –î–∞–Ω–Ω—ã–µ
        data.forEach(item => {
          const label = document.createElement('div');
          label.className = 'grid-cell label-cell';
          label.innerHTML = `
            <span>${escapeHtml(item.group)}</span>
            <span class="total-time">(${item.totalStr})</span>
          `;
          chartGrid.appendChild(label);

          for(let i=0; i<48; i++){
            const start = i*30;
            const end = (i+1)*30;
            const isOff = item.ranges.some(r => start < r.end && end > r.start);
            
            const cell = document.createElement('div');
            cell.className = `grid-cell data-cell ${isOff ? 'off' : ''}`;
            if(isOff) {
              cell.innerHTML = `<i class="material-icons" style="font-size:14px">flash_off</i>`;
            }
            chartGrid.appendChild(cell);
          }
        });

        // 4. –ò–¢–û–ì–û
        const grandTotalMins = data.reduce((acc, item) => acc + item.totalMinsNumeric, 0);
        const footerRow = document.createElement('div');
        footerRow.className = 'grid-footer';
        footerRow.innerHTML = `–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–≤–µ—Ç–∞ (—Å—É–º–º–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º): <strong>${fmtDuration(grandTotalMins)}</strong>`;
        chartGrid.appendChild(footerRow);
      }

      // --- –°–ö–ê–ß–ò–í–ê–ù–ò–ï ---
      downloadPngBtn.addEventListener('click', function() {
        const el = document.getElementById('chart-grid');
        const originalText = this.innerHTML;
        this.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        this.disabled = true;

        html2canvas(el, {
          backgroundColor: '#0f1724',
          scale: 2 
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `svet-chart-${getChartDate()}.png`; 
          link.href = canvas.toDataURL();
          link.click();
        }).catch(err => {
          console.error(err);
          M.toast({html: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', classes: 'red'});
        }).finally(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        });
      });

      generateVizBtn.addEventListener('click', generateChart);
    });
  </script>
</body>
</html>
